import{l as a,g as l,h as S,d,u as m,a as n,c as f,p as E}from"./scheduleTriggerService.f37e76f4.js";const p="https://www.writestack.io",u={getSubstackCookies:async()=>new Promise((e,s)=>{chrome.cookies.getAll({domain:"substack.com"},t=>{if(chrome.runtime.lastError){n("Error fetching cookies:",chrome.runtime.lastError),s(chrome.runtime.lastError.message);return}if(!t||t.length===0){console.warn("No Substack cookies found."),e({message:"No Substack cookies found.",action:"SUBSTACK_COOKIES_FETCHED",result:""});return}const r=["substack.sid","__cf_bm","substack.lli"];a("Cookies:",t);const c=t.filter(i=>r.includes(i.name));if(c.length===0){console.warn("No relevant Substack auth cookies found."),e({message:"No relevant Substack auth cookies found.",action:"SUBSTACK_COOKIES_FETCHED",result:""});return}const o=c.map(i=>({name:i.name,value:i.value,expiresAt:i.expirationDate||null,domain:i.domain,path:i.path,secure:i.secure,httpOnly:i.httpOnly,sameSite:i.sameSite||"unspecified"})),g=JSON.stringify(o);e({message:"Cookies fetched successfully",action:"SUBSTACK_COOKIES_FETCHED",result:g})})}),createSubstackPost:async e=>{try{const s=typeof e=="string"?e:JSON.stringify(e),t=await fetch("https://substack.com/api/v1/comment/feed",{headers:{"content-type":"application/json",Referer:"https://substack.com/home",Origin:"https://substack.com"},credentials:"include",body:s,method:"POST"}),r=await t.json();return t.ok?(a("Response:",t),a("Data after post sent:",r),{message:"Post created successfully",action:"SUBSTACK_POST_CREATED",result:JSON.stringify(r)}):(a("Response:",t),a("Data:",r),{message:"Failed to create post",action:"SUBSTACK_POST_CREATED",result:JSON.stringify({error:"Failed to create post"})})}catch(s){const t=s instanceof Error?s.message:String(s);throw a("Error creating Substack post",{error:t}),n("Error creating Substack post:",s),s}},setSubstackCookies:async()=>{const e=await u.getSubstackCookies(),s=JSON.parse(e.result);a("Sending to server:",JSON.stringify(s));try{const t=await fetch(`${p}/api/user/cookies`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!t.ok)return n("Failed to send cookies to server"),e;const r=await t.json();return a("Cookies sent to server successfully",r),e}catch(t){return n("Error sending cookies to server:",t),e}},createSchedule:async(e,s,t)=>{try{a("Creating schedule",{scheduleId:e,userId:s,timestamp:t});const r=await f(e,s,t);return a("Schedule created successfully",r),{message:"Schedule created successfully",action:"SCHEDULE_CREATED",result:r}}catch(r){const c=r instanceof Error?r.message:String(r);throw n("Error creating schedule:",c),r}},deleteSchedule:async e=>{try{const s=await d(e);return{message:s?"Schedule deleted successfully":"Schedule not found",action:"SCHEDULE_DELETED",result:s}}catch(s){const t=s instanceof Error?s.message:String(s);throw n("Error deleting schedule:",t),s}},getSchedules:async()=>{try{const{schedules:e,alarms:s}=await l();return{message:`Found ${e.length} schedules`,action:"SCHEDULES_FETCHED",result:{schedules:e,alarms:s}}}catch(e){const s=e instanceof Error?e.message:String(e);throw n("Error getting schedules:",s),e}},uploadImagesToSubstack:async e=>{if(a("Uploading images to Substack:",e),!e||!e.length)return{message:"No images to upload",action:"IMAGES_UPLOADED",result:[]};const s=[];try{const t=await E(e),r=new Map;t.forEach(c=>{r.set(c.url,c)});for(const c of e){const o=r.get(c);o?s.push({url:c,success:!0,attachmentId:o.id}):s.push({url:c,success:!1})}return{message:`Successfully uploaded ${t.length} of ${e.length} images`,action:"IMAGES_UPLOADED",result:s}}catch(t){const r=t instanceof Error?t.message:String(t);n("Error uploading images to Substack:",r);const c=new Set(s.map(o=>o.url));for(const o of e)c.has(o)||s.push({url:o,success:!1});return{message:`Error uploading images: ${r}`,action:"IMAGES_UPLOADED",result:s}}}};function h(e,s=[]){switch(e){case"getSubstackCookies":return u.getSubstackCookies();case"setSubstackCookies":return u.setSubstackCookies();case"createSubstackPost":return u.createSubstackPost(s[0],s[1],s[2]);case"createSchedule":return u.createSchedule(s[0],s[1],s[2]);case"deleteSchedule":return u.deleteSchedule(s[0]);case"getSchedules":return u.getSchedules();case"uploadImagesToSubstack":return u.uploadImagesToSubstack(s[0]);default:return Promise.reject(new Error(`Unknown action: ${e}`))}}chrome.alarms.onAlarm.addListener(async e=>{a(`Alarm triggered: ${e.name}`);const{schedules:s}=await l(),t=s.find(r=>r.scheduleId===e.name);if(t){a(`Processing schedule: ${t.scheduleId}`);try{const r=await S(t);if(a(`Schedule ${t.scheduleId} processed:`,r),r.status==="sent")await d(t.scheduleId);else{if(r.status==="processing")return;await m(t.scheduleId,r.status,r.error)}}catch(r){n(`Error handling schedule ${t.scheduleId}:`,r)}}});chrome.runtime.onMessageExternal.addListener((e,s,t)=>{if(a("Background script received external message:",{request:e,sender:s==null?void 0:s.url,type:e==null?void 0:e.type}),(e==null?void 0:e.type)==="PING"){a("Received external PING, responding immediately");const r=chrome.runtime.getManifest().version;return a("Version:",r),t({success:!0,timestamp:Date.now(),version:r,message:"Extension is active",source:"external"}),!1}if((e==null?void 0:e.type)==="API_REQUEST"){const{action:r,params:c}=e;if(a("Received API request:",{action:r,params:c}),r)return h(r,c).then(o=>{t({success:!0,data:o})}).catch(o=>{n(`Error in API request (${r}):`,o),t({success:!1,error:o.message})}),!0}return!1});chrome.runtime.onMessage.addListener((e,s,t)=>{if(a(`Background got internal from ${s.url} message: ${JSON.stringify(e)}`),(e==null?void 0:e.type)==="PING")return t({success:!0,timestamp:Date.now(),message:"Extension is active",source:"internal"}),!1;if((e==null?void 0:e.type)==="API_REQUEST"){const{action:r,params:c}=e;if(a("API request:",{action:r,params:c}),r)return h(r,c).then(o=>{t({success:!0,data:o})}).catch(o=>{n(`Error in API request (${r}):`,o),t({success:!1,error:o.message})}),!0}return!1});
//# sourceMappingURL=background.js.map
